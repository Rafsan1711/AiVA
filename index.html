<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AiVA - AI Virtual Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" crossorigin="anonymous">
    <!-- Prism for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; background: #111827; color: #f9fafb; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator { display: inline-flex; align-items: center; gap: 4px; }
        .typing-dot { width: 8px; height: 8px; background: #64748b; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .code-block { background: #1e293b; border-radius: 8px; padding: 16px; margin: 12px 0; overflow-x: auto; }
        .sidebar-scroll::-webkit-scrollbar { width: 6px; } .sidebar-scroll::-webkit-scrollbar-track { background: #1e293b; } .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .dropdown { position: absolute; right: 16px; top: 50px; background: #374151; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 50; min-width: 150px; display: none; }
        .dropdown.active { display: block; } .dropdown button { width: 100%; text-align: left; padding: 12px 16px; border: none; background: none; color: #e5e7eb; cursor: pointer; transition: background 0.2s; } .dropdown button:hover { background: #4b5563; } .dropdown button:first-child { border-radius: 8px 8px 0 0; } .dropdown button:last-child { border-radius: 0 0 8px 8px; }
        .warning-banner { background: #fbbf24; color: #92400e; padding: 8px 16px; text-align: center; font-size: 14px; font-weight: 500; }
        .logo-placeholder { width: 40px; height: 40px; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); border-radius: 8px; display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:18px; }
        .pulse { animation: pulse 2s infinite; } @keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.5;} }
        .mobile-overlay { display: none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index:40; }
        .mobile-sidebar { transform: translateX(-100%); transition: transform 0.3s ease-in-out; } .mobile-sidebar.open { transform: translateX(0); }
        .plugin-card { background: #374151; border-radius: 12px; padding: 20px; border: 2px solid transparent; transition: all 0.3s ease; cursor: pointer; }
        .plugin-card:hover { border-color: #667eea; transform: translateY(-2px); } .plugin-card.enabled { border-color: #10b981; background: #065f46; }
        .plugin-enabled-badge { background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight:500; }
        .plugin-disabled-badge { background: #6b7280; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight:500; }
        .file-card { background: #111827; border: 1px solid #374151; padding: 10px; border-radius: 8px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
        .file-card:hover { border-color: #475569; }
        .code-view { background: #0f172a; border-radius:8px; padding:12px; overflow:auto; }
        .line-issue { background: rgba(220,38,38,0.08); display:block; }
        .line-ok { background: rgba(34,197,94,0.06); display:block; }
        .chip { background:#374151; padding:6px 10px; border-radius:8px; font-size:13px; }
        .btn { padding:8px 12px; border-radius:8px; cursor:pointer; }
        .btn-primary { background:#2563eb; color:white; border:none; }
        .btn-ghost { background:transparent; border:1px solid #374151; color:#e5e7eb; }
        .debug-line { display:block; padding:0 6px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; font-size:13px; }
        .code-plugin-modal { position: fixed; inset:0; background: rgba(0,0,0,0.6); z-index:60; display:none; align-items:center; justify-content:center; }
        .code-plugin-modal.open { display:flex; }
        .code-plugin-window { width: 96%; max-width: 1200px; height: 88vh; background: #0b1220; border-radius: 12px; padding: 14px; display:flex; gap:12px; border:1px solid #263241; }
        .files-pane { width: 320px; background:#071025; border-radius:8px; padding:12px; display:flex; flex-direction:column; gap:12px; }
        .editor-pane { flex:1; background: #021021; border-radius:8px; padding:12px; display:flex; flex-direction:column; gap:12px; }
        .files-list { overflow:auto; max-height: calc(88vh - 220px); }
        .create-form { display:flex; flex-direction:column; gap:8px; }
        .feature-chat { max-height: 42vh; overflow:auto; padding:8px; border-radius:8px; background:#071025; }
        .chat-bubble.ai { background: linear-gradient(90deg,#0f172a,#0b1220); padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #263241; }
        .chat-bubble.user { background:#06303f; padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid #13313f; color:#cce7ff; }
        @media (max-width: 900px) {
            .code-plugin-window { flex-direction:column; height: 92vh; }
            .files-pane { width:100%; height: 220px; display:flex; }
            .editor-pane { width:100%; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen overflow-hidden">
    <!-- Terms Modal -->
    <div id="termsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg max-w-2xl max-h-[80vh] overflow-y-auto border border-gray-700">
            <div class="flex items-center gap-3 mb-6">
                <div class="logo-placeholder">AI</div>
                <h2 class="text-2xl font-bold">Terms of Service & Privacy Policy</h2>
            </div>
            <div class="space-y-4 text-sm text-gray-300">
                <div>
                    <h3 class="font-semibold text-lg mb-2 text-white">Terms of Service</h3>
                    <p>By using AiVA, you agree to use this service responsibly. Do not share personal, sensitive, or illegal content. This service is provided as-is without warranties. You may send u[...]</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-2 text-white">Privacy Policy</h3>
                    <p>We collect minimal data necessary for service functionality. Conversations may be processed by AI services. We don't sell your data to third parties. Your data is handled accord[...]</p>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-2 text-white">Usage Limits</h3>
                    <p>Each chat session is limited to 7 messages to ensure fair usage and optimal performance. Progress is saved automatically.</p>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button id="acceptTerms" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded transition-colors">Accept</button>
                <button id="declineTerms" class="bg-gray-600 hover:bg-gray-700 px-6 py-2 rounded transition-colors">Decline</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full mx-4 border border-gray-700">
            <div class="text-center mb-6">
                <div class="logo-placeholder mx-auto mb-3">AI</div>
                <h1 class="text-4xl font-bold mb-2">AiVA</h1>
                <p class="text-gray-400">AI Virtual Assistant</p>
            </div>
            <div id="loginForm" class="space-y-4">
                <h2 class="text-xl text-white font-semibold mb-4">Sign In</h2>
                <input id="loginEmail" type="email" placeholder="Email" class="w-full p-3 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                <input id="loginPassword" type="password" placeholder="Password" class="w-full p-3 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded font-medium">Sign In</button>
                <button id="googleSignInBtn" class="w-full bg-red-600 hover:bg-red-700 p-3 rounded font-medium">Sign in with Google</button>
                <p class="text-center text-sm">
                    Don't have an account? 
                    <button id="showSignUp" class="text-blue-400 hover:underline">Sign Up</button>
                </p>
            </div>
            <div id="signUpForm" class="space-y-4 hidden">
                <h2 class="text-xl text-white font-semibold mb-4">Sign Up</h2>
                <input id="signUpEmail" type="email" placeholder="Email" class="w-full p-3 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                <input id="signUpPassword" type="password" placeholder="Password" class="w-full p-3 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                <input id="confirmPassword" type="password" placeholder="Confirm Password" class="w-full p-3 bg-gray-700 rounded border border-gray-600 focus:border-blue-500 focus:outline-none">
                <button id="signUpBtn" class="w-full bg-green-600 hover:bg-green-700 p-3 rounded font-medium">Sign Up</button>
                <button id="googleSignUpBtn" class="w-full bg-red-600 hover:bg-red-700 p-3 rounded font-medium">Sign up with Google</button>
                <p class="text-center text-sm">
                    Already have an account? 
                    <button id="showSignIn" class="text-blue-400 hover:underline">Sign In</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Settings, Archive, Plugins, Main App markup kept as in original (omitted here for brevity in markup reproduction) -->
    <!-- Important: The code plugin modal and plugin card are included below. -->

    <!-- Plugins Modal -->
    <div id="pluginsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4 border border-gray-700 max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Plugins</h2>
                <button id="closePlugins" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="grid gap-4">
                <!-- Chess Plugin Card (existing) -->
                <div class="plugin-card" id="chessPlugin" data-plugin="chess">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg flex items-center justify-center text-2xl">♗</div>
                            <div>
                                <h3 class="text-lg font-semibold">Chess Master</h3>
                                <p class="text-sm text-gray-400">Play chess games with AI opponent</p>
                            </div>
                        </div>
                        <div class="plugin-disabled-badge" id="chessBadge">Disabled</div>
                    </div>
                    <p class="text-sm text-gray-300 mb-4">Challenge the AI to strategic chess matches. Features interactive board, move analysis, and post-game insights to improve your gameplay.</p>
                    <button class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-medium transition-colors" onclick="togglePlugin('chess')">
                        <span id="chessToggleText">Enable Plugin</span>
                    </button>
                </div>

                <!-- Code Studio Plugin Card -->
                <div class="plugin-card" id="codePluginCard" data-plugin="code_editor">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-sky-500 to-indigo-700 rounded-lg flex items-center justify-center text-2xl">💻</div>
                            <div>
                                <h3 class="text-lg font-semibold">Code Studio</h3>
                                <p class="text-sm text-gray-400">Create / edit files with AI-assisted feature generation & debugging (single persistent chat)</p>
                            </div>
                        </div>
                        <div class="plugin-disabled-badge" id="codeBadge">Disabled</div>
                    </div>
                    <p class="text-sm text-gray-300 mb-4">Manage project files (html, css, js, json, etc.) saved in Firebase. Use AI to generate features, code, debug and finalize files.</p>
                    <button id="toggleCodePluginBtn" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-medium transition-colors">Enable Plugin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Plugin Modal (single persistent chat) -->
    <div id="codePluginModal" class="code-plugin-modal" aria-hidden="true">
        <div class="code-plugin-window" role="dialog" aria-modal="true" aria-labelledby="codePluginTitle">
            <!-- Files pane -->
            <div class="files-pane">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="logo-placeholder">AI</div>
                        <div class="mt-2 text-sm text-gray-300">Code Studio</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="closeCodePlugin" class="btn btn-ghost">Close</button>
                        <button id="deleteCodePlugin" class="btn btn-ghost text-red-400">Delete</button>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="flex items-center gap-2">
                        <button id="createFileToggleBtn" class="btn btn-primary">Create a new file +</button>
                        <div id="createFileForm" class="create-form hidden w-full">
                            <input id="newFileName" class="w-full p-2 bg-gray-800 rounded border border-gray-700 text-sm" placeholder="Filename (e.g., index.html)" />
                            <textarea id="newFileContent" rows="6" class="w-full p-2 bg-gray-800 rounded border border-gray-700 text-sm" placeholder="Paste file code here..."></textarea>
                            <div class="flex gap-2">
                                <button id="createFileBtn" class="btn btn-primary">Create</button>
                                <button id="cancelCreateFileBtn" class="btn btn-ghost">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="text-xs text-gray-400">Files</div>
                    <div id="filesList" class="files-list mt-2 space-y-2">
                        <!-- File cards rendered here -->
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="text-xs text-gray-400 mb-2">Plugin Options</div>
                    <div class="flex flex-col gap-2">
                        <button id="exportAllBtn" class="btn btn-ghost">Export files (ZIP)</button>
                        <button id="syncNowBtn" class="btn btn-ghost">Sync with Firebase</button>
                    </div>
                </div>
            </div>

            <!-- Editor / Chat pane -->
            <div class="editor-pane">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="codePluginTitle" class="text-lg font-semibold">Code Studio — AI Assisted</h2>
                        <div id="currentFilename" class="text-xs text-gray-400 mt-1">No file opened</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="pluginStatus" class="chip">Single Chat</div>
                        <button id="commitFileBtn" class="btn btn-primary" disabled>Commit Changes</button>
                        <button id="downloadFileBtn" class="btn btn-ghost" disabled>Download</button>
                    </div>
                </div>

                <div class="flex gap-3 items-start">
                    <div style="flex:1.2">
                        <div class="mb-2 flex items-center gap-2">
                            <textarea id="featureInput" class="w-full p-3 bg-gray-800 rounded border border-gray-700 text-sm" placeholder="Describe a feature (e.g. signup/login improvements)"></textarea>
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <button id="generateFeatureBtn" class="btn btn-primary">Generate feature with AI</button>
                            <button id="sendFeatureBtn" class="btn btn-ghost">Send</button>
                            <div id="featureButtonsPlaceholder" class="ml-auto text-xs text-gray-400">You can auto-generate suggestions or type your own</div>
                        </div>

                        <div id="chatArea" class="feature-chat" aria-live="polite">
                            <!-- Chat messages for feature generation and AI responses -->
                        </div>

                        <div class="mt-2 flex items-center gap-2">
                            <button id="finalSatisfiedBtn" class="btn btn-primary hidden">Satisfied</button>
                            <button id="finalNotSatisfiedBtn" class="btn btn-ghost hidden">Not satisfied</button>
                        </div>
                    </div>

                    <div style="flex:1">
                        <div class="mb-2 flex items-center justify-between">
                            <div class="text-sm text-gray-300">Preview / Generated Code</div>
                            <div class="text-xs text-gray-400">AI code cards appear here</div>
                        </div>
                        <div id="generatedArea" class="code-view" style="max-height:56vh; overflow:auto;">
                            <!-- AI generated code cards -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal for Code Plugin -->
    <div id="deleteCodeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-60 hidden">
        <div class="bg-gray-800 p-6 rounded-lg max-w-lg w-full border border-gray-700">
            <h3 class="text-lg font-semibold mb-2">Delete Code Studio Chat & Files</h3>
            <p class="text-sm text-gray-300 mb-4">Deleting will remove all files and chat history associated with this plugin for your account. This action is irreversible.</p>
            <div class="flex items-center gap-2 mb-4">
                <input id="confirmDeleteCheckbox" type="checkbox" />
                <label for="confirmDeleteCheckbox" class="text-sm text-gray-300">I understand this will permanently delete files and chat history.</label>
            </div>
            <div class="flex gap-2 justify-end">
                <button id="cancelDeleteCode" class="btn btn-ghost">Cancel</button>
                <button id="confirmDeleteCode" class="btn btn-primary" disabled>Delete</button>
            </div>
        </div>
    </div>

    <!-- Warning Banner (hidden by default) -->
    <div id="warningBanner" class="warning-banner hidden">
        ⚠️ You have reached the message limit for this chat (7/7). Please start a new chat to continue.
    </div>

    <!-- Mobile Header, Main App, Messages container, Input etc. kept exactly as original structure -->
    <div id="mainApp" class="flex h-screen hidden">
        <!-- left sidebar, chat area and other UI elements are re-used from original code -->
        <!-- For brevity in the markup reproduction we rely on the earlier detailed code and JS to manage interactions -->
        <!-- The full interactive behavior is implemented in the JavaScript below. -->
        <div class="desktop-sidebar w-80 bg-gray-800 flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="logo-placeholder">AI</div>
                    <div>
                        <h1 class="text-xl font-bold">AiVA</h1>
                        <p class="text-xs text-gray-400">AI Virtual Assistant</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="newChatBtn" class="p-2 hover:bg-gray-700 rounded" title="New Chat">+</button>
                    <button id="settingsBtn" class="p-2 hover:bg-gray-700 rounded" title="Settings">⚙</button>
                    <button id="archiveBtn" class="p-2 hover:bg-gray-700 rounded" title="Archives">📁</button>
                </div>
            </div>

            <div class="p-4 border-b border-gray-700">
                <button id="pluginsBtn" class="w-full text-left p-2 hover:bg-gray-700 rounded flex items-center gap-2 text-sm font-medium">
                    <span>🧩</span> Plugins
                </button>
                <div id="enabledPlugins" class="mt-2 space-y-1"></div>
            </div>

            <div class="p-4">
                <input id="searchChats" type="text" placeholder="Search conversations..." class="w-full p-2 bg-gray-700 rounded text-sm border border-gray-600 focus:border-blue-500 focus:outline-none"/>
            </div>

            <div class="flex-1 overflow-y-auto sidebar-scroll">
                <div id="chatHistory" class="p-2 space-y-2"></div>
            </div>

            <div class="p-4 border-t border-gray-700">
                <div id="userInfo" class="flex items-center gap-3">
                    <div id="userAvatar" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold overflow-hidden">
                        <img id="userPhoto" class="w-full h-full object-cover rounded-full hidden" />
                        <span id="userInitial"></span>
                    </div>
                    <div class="flex-1">
                        <div id="userName" class="text-sm font-medium">User</div>
                        <div class="text-xs text-gray-400">Online</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area flex-1 flex flex-col">
            <div class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center relative">
                <div class="flex items-center gap-3">
                    <div id="chatAvatar" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold">AI</div>
                    <div>
                        <div id="chatTitle" class="font-medium">AiVA Assistant</div>
                        <div id="statusIndicator" class="text-xs text-gray-400">Online</div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div id="messageCount" class="text-sm text-gray-400 hidden md:block">0/7</div>
                    <button id="chatMenuBtn" class="p-2 hover:bg-gray-700 rounded">⋮</button>
                </div>
                <div id="chatDropdown" class="dropdown">
                    <button id="archiveChat">📁 Archive Chat</button>
                    <button id="deleteChat" class="text-red-400">🗑️ Delete Chat</button>
                </div>
            </div>

            <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-500 mt-8">
                    <div class="logo-placeholder mx-auto mb-4 pulse">AI</div>
                    <h3 class="text-lg font-medium mb-1">Welcome to AiVA</h3>
                    <p class="text-sm">Your AI Virtual Assistant is ready to help!</p>
                    <p class="text-xs text-gray-600 mt-2">You can send up to 7 messages per chat</p>
                </div>
            </div>

            <div class="p-4 border-t border-gray-700">
                <div class="flex gap-3 items-end">
                    <div class="flex-1">
                        <textarea id="messageInput" placeholder="Type your message..." class="w-full p-3 bg-gray-700 rounded-lg resize-none border border-gray-600 focus:border-blue-500 focus:outline-none max-h-32" rows="1"></textarea>
                    </div>
                    <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 p-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <!-- Prism JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.28.0/components/prism-json.min.js"></script>

    <!-- Chess Dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" crossorigin="anonymous"></script>
    <script src="js/chess.js"></script>

    <!-- Sounds -->
    <audio id="moveSound" src="sounds/move.mp3"></audio>
    <audio id="captureSound" src="sounds/capture.mp3"></audio>
    <audio id="promoteSound" src="sounds/promote.mp3"></audio>
    <audio id="castlingSound" src="sounds/castling.mp3"></audio>
    <audio id="incorrectMoveSound" src="sounds/incorrect-move.mp3"></audio>
    <audio id="checkSound" src="sounds/check.mp3"></audio>
    <audio id="checkmateSound" src="sounds/checkmate.mp3"></audio>

    <script>
    /*************************************************************************
     * Firebase + Server configuration
     *************************************************************************/
    const firebaseConfig = {
        apiKey: "AIzaSyD9QkbeIywF3HN1bS0A0g2uIRVXOC6q1wM",
        authDomain: "aiva-9abbb.firebaseapp.com",
        projectId: "aiva-9abbb",
        storageBucket: "aiva-9abbb.firebasestorage.app",
        messagingSenderId: "565052629821",
        appId: "1:565052629821:web:4a0083611ff11011da1b54"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    const SERVER_BASE = "https://aiva-gwm9.onrender.com";
    const MESSAGE_LIMIT = 7;

    /*************************************************************************
     * Global state and element map
     *************************************************************************/
    let currentUser = null;
    let currentChatId = null;
    let conversationHistory = [];
    let chatHistoryData = {};
    let messageCount = 0;
    let archivedChats = {};
    let hasAcceptedTerms = false;
    let enabledPlugins = {};
    let isChessConversation = false;
    let chessGameData = null;

    // Plugin specific state (initialized later)
    let codePluginRef = null;
    let userFilesRef = null;
    let userChatRef = null;
    let filesCache = {};
    let currentOpenFile = null;
    let chatMessages = [];

    const elements = {
        termsModal: document.getElementById('termsModal'),
        authModal: document.getElementById('authModal'),
        settingsModal: document.getElementById('settingsModal'),
        archiveModal: document.getElementById('archiveModal'),
        pluginsModal: document.getElementById('pluginsModal'),
        warningBanner: document.getElementById('warningBanner'),
        mainApp: document.getElementById('mainApp'),
        loginForm: document.getElementById('loginForm'),
        signUpForm: document.getElementById('signUpForm'),
        messagesContainer: document.getElementById('messagesContainer'),
        messageInput: document.getElementById('messageInput'),
        sendBtn: document.getElementById('sendBtn'),
        chatHistory: document.getElementById('chatHistory'),
        mobileChatHistory: document.getElementById('mobileChatHistory'),
        userInfo: document.getElementById('userInfo'),
        userName: document.getElementById('userName'),
        userAvatar: document.getElementById('userAvatar'),
        userPhoto: document.getElementById('userPhoto'),
        userInitial: document.getElementById('userInitial'),
        mobileUserName: document.getElementById('mobileUserName'),
        mobileUserAvatar: document.getElementById('mobileUserAvatar'),
        mobileUserPhoto: document.getElementById('mobileUserPhoto'),
        mobileUserInitial: document.getElementById('mobileUserInitial'),
        statusIndicator: document.getElementById('statusIndicator'),
        messageCount: document.getElementById('messageCount'),
        mobileMessageCount: document.getElementById('mobileMessageCount'),
        chatDropdown: document.getElementById('chatDropdown'),
        archivedChats: document.getElementById('archivedChats'),
        enabledPlugins: document.getElementById('enabledPlugins'),
        mobileEnabledPlugins: document.getElementById('mobileEnabledPlugins'),
        mobileSidebar: document.getElementById('mobileSidebar'),
        mobileOverlay: document.getElementById('mobileOverlay'),
        chatTitle: document.getElementById('chatTitle'),
        chatAvatar: document.getElementById('chatAvatar')
    };

    // Elements used by plugin integration
    const codePluginModal = document.getElementById('codePluginModal');
    const toggleCodePluginBtn = document.getElementById('toggleCodePluginBtn');
    const codeBadge = document.getElementById('codeBadge');
    const createFileToggleBtn = document.getElementById('createFileToggleBtn');
    const createFileForm = document.getElementById('createFileForm');
    const newFileName = document.getElementById('newFileName');
    const newFileContent = document.getElementById('newFileContent');
    const createFileBtn = document.getElementById('createFileBtn');
    const cancelCreateFileBtn = document.getElementById('cancelCreateFileBtn');
    const filesList = document.getElementById('filesList');
    const closeCodePlugin = document.getElementById('closeCodePlugin');
    const deleteCodePlugin = document.getElementById('deleteCodePlugin');
    const deleteCodeModal = document.getElementById('deleteCodeModal');
    const confirmDeleteCheckbox = document.getElementById('confirmDeleteCheckbox');
    const confirmDeleteCode = document.getElementById('confirmDeleteCode');
    const cancelDeleteCode = document.getElementById('cancelDeleteCode');
    const featureInput = document.getElementById('featureInput');
    const generateFeatureBtn = document.getElementById('generateFeatureBtn');
    const sendFeatureBtn = document.getElementById('sendFeatureBtn');
    const chatArea = document.getElementById('chatArea');
    const generatedArea = document.getElementById('generatedArea');
    const commitFileBtn = document.getElementById('commitFileBtn');
    const downloadFileBtn = document.getElementById('downloadFileBtn');
    const currentFilenameEl = document.getElementById('currentFilename');
    const finalSatisfiedBtn = document.getElementById('finalSatisfiedBtn');
    const finalNotSatisfiedBtn = document.getElementById('finalNotSatisfiedBtn');
    const createFileToggle = document.getElementById('createFileToggleBtn');

    /*************************************************************************
     * Utility helpers
     *************************************************************************/
    function showToast(msg) {
        console.log('[TOAST]', msg);
    }

    function uidPath() {
        if (!currentUser) return null;
        return `users/${currentUser.uid}/plugins/code_editor`;
    }

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function (m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });
    }

    function detectLanguageFromFilename(fname) {
        if (!fname) return 'markup';
        const ext = fname.split('.').pop().toLowerCase();
        if (ext === 'html' || ext === 'htm') return 'markup';
        if (ext === 'js') return 'javascript';
        if (ext === 'css') return 'css';
        if (ext === 'json') return 'json';
        return 'markup';
    }

    function parseAICodeBlocks(text) {
        const results = [];
        const fileMarkerRegex = /===\s*FILE:\s*([^\s=]+)\s*===\s*```([a-zA-Z0-9+-]*)\n([\s\S]*?)```/g;
        let m;
        while ((m = fileMarkerRegex.exec(text)) !== null) {
            const filename = m[1].trim();
            const lang = m[2] || detectLanguageFromFilename(filename);
            const code = m[3].replace(/\r\n/g, '\n').trim();
            results.push({ filename, lang, code });
        }
        const fenceRegex = /```([a-zA-Z0-9+-]*)\n([\s\S]*?)```/g;
        while ((m = fenceRegex.exec(text)) !== null) {
            const lang = m[1] || 'text';
            const code = m[2].replace(/\r\n/g, '\n').trim();
            const before = text.slice(0, m.index).split('\n').slice(-3).join('\n');
            let filename = null;
            const fnMatch = before.match(/FILE[:\s-]+([^\s]+)/i) || before.match(/filename[:\s-]+([^\s]+)/i) || before.match(/^\s*([a-zA-Z0-9_\-]+\.[a-zA-Z0-9]+)/m);
            if (fnMatch) filename = fnMatch[1];
            results.push({ filename, lang, code });
        }
        if (results.length === 0) {
            results.push({ filename: 'generated.txt', lang: 'text', code: text });
        }
        return results;
    }

    function extractJson(text) {
        const start = text.indexOf('{');
        const end = text.lastIndexOf('}');
        if (start === -1 || end === -1 || end <= start) return null;
        const snippet = text.slice(start, end + 1);
        try {
            JSON.parse(snippet);
            return snippet;
        } catch (e) {
            const fenceJson = (text.match(/```json\n([\s\S]*?)```/) || [])[1];
            if (fenceJson) {
                try {
                    JSON.parse(fenceJson);
                    return fenceJson;
                } catch (e2) {
                    return null;
                }
            }
            return null;
        }
    }

    /*************************************************************************
     * Server communication wrapper
     *************************************************************************/
    async function callServerQuery({ message, conversationType = 'regular', model = undefined, max_tokens = undefined }) {
        try {
            const payload = { message, conversationType };
            if (model) payload.model = model;
            if (max_tokens) payload.max_tokens = max_tokens;
            const resp = await fetch(`${SERVER_BASE}/api/query`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const txt = await resp.text();
                throw new Error(`Server error: ${resp.status} ${txt}`);
            }
            const json = await resp.json();
            return json;
        } catch (e) {
            console.error('callServerQuery error', e);
            throw e;
        }
    }

    /*************************************************************************
     * Plugin: Code Studio — firebase listeners & UI actions
     *************************************************************************/
    // Manage persisted enabled plugins locally
    function updateEnabledPluginsUI() {
        const enabledPluginsContainer = document.getElementById('enabledPlugins');
        enabledPluginsContainer.innerHTML = '';
        for (const k in enabledPlugins) {
            if (enabledPlugins[k]) {
                const el = document.createElement('div');
                el.className = 'enabled-plugin-item';
                el.textContent = k === 'code_editor' ? 'Code Studio' : k;
                el.addEventListener('click', () => {
                    if (k === 'code_editor') openCodePlugin();
                });
                enabledPluginsContainer.appendChild(el);
            }
        }
    }

    function togglePlugin(pluginId) {
        if (pluginId === 'chess') {
            const enabled = !enabledPlugins['chess'];
            enabledPlugins['chess'] = enabled;
            localStorage.setItem('aivaEnabledPlugins', JSON.stringify(enabledPlugins));
            document.getElementById('chessBadge').textContent = enabled ? 'Enabled' : 'Disabled';
            document.getElementById('chessToggleText').textContent = enabled ? 'Disable Plugin' : 'Enable Plugin';
            updateEnabledPluginsUI();
        }
    }

    toggleCodePluginBtn.addEventListener('click', () => {
        const enabled = !enabledPlugins['code_editor'];
        enabledPlugins['code_editor'] = enabled;
        localStorage.setItem('aivaEnabledPlugins', JSON.stringify(enabledPlugins));
        codeBadge.textContent = enabled ? 'Enabled' : 'Disabled';
        toggleCodePluginBtn.textContent = enabled ? 'Open Plugin' : 'Enable Plugin';
        if (enabled) openCodePlugin();
        else closeCodePluginModal();
        updateEnabledPluginsUI();
    });

    function openCodePlugin() {
        if (!currentUser) {
            alert('Please sign in to use plugins.');
            return;
        }
        codePluginModal.classList.add('open');
        const base = uidPath();
        codePluginRef = database.ref(base);
        userFilesRef = database.ref(`${base}/files`);
        userChatRef = database.ref(`${base}/chat`);
        listenFiles();
        listenChat();
    }

    function closeCodePluginModal() {
        codePluginModal.classList.remove('open');
        if (userFilesRef) userFilesRef.off();
        if (userChatRef) userChatRef.off();
    }

    closeCodePlugin.addEventListener('click', closeCodePluginModal);

    function listenFiles() {
        filesList.innerHTML = '<div class="text-xs text-gray-400">Loading files...</div>';
        userFilesRef.on('value', snapshot => {
            filesCache = {};
            const val = snapshot.val() || {};
            filesList.innerHTML = '';
            const entries = Object.keys(val).sort();
            if (entries.length === 0) {
                filesList.innerHTML = '<div class="text-xs text-gray-400">No files yet. Create one.</div>';
            } else {
                entries.forEach(name => {
                    const meta = val[name];
                    filesCache[name] = meta;
                    const card = renderFileCard(name, meta);
                    filesList.appendChild(card);
                });
            }
        }, err => {
            console.error('files listen error', err);
            filesList.innerHTML = '<div class="text-xs text-red-400">Error loading files</div>';
        });
    }

    function renderFileCard(name, meta) {
        const container = document.createElement('div');
        container.className = 'file-card';
        const left = document.createElement('div');
        left.style.display = 'flex';
        left.style.alignItems = 'center';
        left.style.gap = '8px';
        const nameEl = document.createElement('div');
        nameEl.textContent = name;
        nameEl.className = 'text-sm';
        left.appendChild(nameEl);

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '6px';
        const openBtn = document.createElement('button');
        openBtn.className = 'btn btn-ghost text-xs';
        openBtn.textContent = 'Open';
        openBtn.addEventListener('click', () => openFile(name));
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-ghost text-xs';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', () => openFile(name, true));
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-ghost text-xs text-red-400';
        delBtn.textContent = 'Delete';
        delBtn.addEventListener('click', () => deleteFile(name));
        right.appendChild(openBtn);
        right.appendChild(editBtn);
        right.appendChild(delBtn);

        container.appendChild(left);
        container.appendChild(right);
        return container;
    }

    createFileToggle.addEventListener('click', () => {
        createFileForm.classList.toggle('hidden');
        if (!createFileForm.classList.contains('hidden')) newFileName.focus();
        else { newFileName.value = ''; newFileContent.value = ''; }
    });
    cancelCreateFileBtn.addEventListener('click', () => {
        createFileForm.classList.add('hidden');
        newFileName.value = '';
        newFileContent.value = '';
    });

    createFileBtn.addEventListener('click', async () => {
        const filename = (newFileName.value || '').trim();
        const content = newFileContent.value || '';
        if (!filename) { alert('Enter a filename'); return; }
        if (filename.includes('/') || filename.includes('\\')) { alert('Invalid filename'); return; }
        try {
            const ref = userFilesRef.child(filename);
            await ref.set({ content, lastModified: Date.now(), modifiedBy: currentUser.uid, version: 1 });
            newFileName.value = '';
            newFileContent.value = '';
            createFileForm.classList.add('hidden');
            showToast(`Created ${filename}`);
        } catch (e) {
            console.error('create file error', e);
            alert('Failed to create file');
        }
    });

    async function deleteFile(filename) {
        if (!confirm(`Delete file ${filename}? This cannot be undone.`)) return;
        try {
            await userFilesRef.child(filename).remove();
            if (currentOpenFile === filename) closeOpenFile();
            showToast(`Deleted ${filename}`);
        } catch (e) {
            console.error('delete file', e);
            alert('Delete failed');
        }
    }

    async function openFile(filename, openForEdit = false) {
        currentOpenFile = filename;
        currentFilenameEl.textContent = filename;
        commitFileBtn.disabled = false;
        downloadFileBtn.disabled = false;
        try {
            const snap = await userFilesRef.child(filename).once('value');
            const data = snap.val();
            const content = (data && data.content) ? data.content : '';
            showInlineEditor(filename, content);
        } catch (e) {
            console.error('open file error', e);
            alert('Unable to open file');
        }
    }

    function showInlineEditor(filename, content) {
        generatedArea.innerHTML = '';
        const editorTop = document.createElement('div');
        editorTop.className = 'mb-3';
        const title = document.createElement('div');
        title.className = 'text-sm text-gray-300 mb-2';
        title.textContent = `Editing: ${filename}`;
        const textarea = document.createElement('textarea');
        textarea.id = 'inlineEditor';
        textarea.rows = 18;
        textarea.className = 'w-full p-2 bg-gray-900 rounded border border-gray-700 text-sm font-mono';
        textarea.value = content;
        editorTop.appendChild(title);
        editorTop.appendChild(textarea);

        const controls = document.createElement('div');
        controls.className = 'flex gap-2 mt-2';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-primary';
        saveBtn.textContent = 'Save to Firebase';
        saveBtn.addEventListener('click', async () => {
            await commitFileChanges(filename, textarea.value);
        });
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-ghost';
        cancelBtn.textContent = 'Close Editor';
        cancelBtn.addEventListener('click', () => {
            generatedArea.innerHTML = '';
            if (lastAIHtml) generatedArea.innerHTML = lastAIHtml;
        });
        const aiGenerateFromFileBtn = document.createElement('button');
        aiGenerateFromFileBtn.className = 'btn btn-ghost';
        aiGenerateFromFileBtn.textContent = 'Ask AI to improve this file';
        aiGenerateFromFileBtn.addEventListener('click', () => {
            featureInput.value = `Improve the following file: ${filename}\n\n---FILE-CONTENT-START---\n${textarea.value}\n---FILE-CONTENT-END---\nPlease explain what you would change and provide a full updated file.`;
            sendFeature();
        });

        controls.appendChild(saveBtn);
        controls.appendChild(aiGenerateFromFileBtn);
        controls.appendChild(cancelBtn);

        generatedArea.appendChild(editorTop);
        generatedArea.appendChild(controls);
    }

    async function commitFileChanges(filename, newContent) {
        try {
            const snap = await userFilesRef.child(filename).once('value');
            const meta = snap.val() || {};
            const newVersion = (meta.version || 0) + 1;
            await userFilesRef.child(filename).set({ content: newContent, lastModified: Date.now(), modifiedBy: currentUser.uid, version: newVersion });
            showToast(`Saved ${filename}`);
        } catch (e) {
            console.error('commit error', e);
            alert('Failed to save file');
        }
    }

    function closeOpenFile() {
        currentOpenFile = null;
        currentFilenameEl.textContent = 'No file opened';
        commitFileBtn.disabled = true;
        downloadFileBtn.disabled = true;
        generatedArea.innerHTML = '';
    }

    downloadFileBtn.addEventListener('click', () => {
        if (!currentOpenFile) return;
        userFilesRef.child(currentOpenFile).once('value').then(snap => {
            const data = snap.val() || {};
            const content = data.content || '';
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentOpenFile;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    });

    function listenChat() {
        userChatRef.on('value', snap => {
            const val = snap.val() || {};
            chatMessages = val.messages || [];
            renderChat();
        });
    }

    function renderChat() {
        chatArea.innerHTML = '';
        for (const m of chatMessages) {
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble ' + (m.role === 'ai' ? 'ai' : 'user');
            bubble.innerHTML = `<div style="white-space:pre-wrap;">${escapeHtml(m.content)}</div>`;
            if (m.role === 'ai' && m.content && /```/.test(m.content)) {
                const parsed = parseAICodeBlocks(m.content);
                parsed.forEach(item => {
                    const codeCard = document.createElement('div');
                    codeCard.className = 'mt-2 p-2 bg-[#071025] rounded';
                    const header = document.createElement('div');
                    header.className = 'flex items-center justify-between gap-2 mb-2';
                    const fname = document.createElement('div');
                    fname.className = 'text-xs text-gray-300';
                    fname.textContent = item.filename || 'generated';
                    const actions = document.createElement('div');
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'btn btn-ghost text-xs';
                    copyBtn.textContent = 'Copy code';
                    copyBtn.addEventListener('click', () => navigator.clipboard.writeText(item.code));
                    const debugBtn = document.createElement('button');
                    debugBtn.className = 'btn btn-ghost text-xs';
                    debugBtn.textContent = 'Debug';
                    debugBtn.addEventListener('click', () => debugCode(item.filename || 'generated', item.code));
                    actions.appendChild(copyBtn);
                    actions.appendChild(debugBtn);
                    header.appendChild(fname);
                    header.appendChild(actions);
                    codeCard.appendChild(header);

                    const pre = document.createElement('pre');
                    pre.className = 'language-none';
                    const code = document.createElement('code');
                    const lang = detectLanguageFromFilename(item.filename);
                    pre.className = 'language-' + (lang || 'markup');
                    code.className = 'language-' + (lang || 'markup');
                    code.textContent = item.code;
                    pre.appendChild(code);
                    codeCard.appendChild(pre);
                    Prism.highlightElement(code);
                    bubble.appendChild(codeCard);
                });
            }
            chatArea.appendChild(bubble);
        }
        if (chatMessages.length > 0) {
            const last = chatMessages[chatMessages.length - 1];
            if (last.role === 'ai' && (/final code/i.test(last.content) || /Satisfaction/i.test(last.content) || /```/.test(last.content))) {
                finalSatisfiedBtn.classList.remove('hidden');
                finalNotSatisfiedBtn.classList.remove('hidden');
            } else {
                finalSatisfiedBtn.classList.add('hidden');
                finalNotSatisfiedBtn.classList.add('hidden');
            }
        } else {
            finalSatisfiedBtn.classList.add('hidden');
            finalNotSatisfiedBtn.classList.add('hidden');
        }
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function pushChatMessage(obj) {
        try {
            const snap = await userChatRef.child('messages').once('value');
            const arr = snap.val() || [];
            arr.push(obj);
            await userChatRef.child('messages').set(arr);
        } catch (e) {
            console.error('push chat', e);
        }
    }

    generateFeatureBtn.addEventListener('click', async () => {
        if (!currentUser) { alert('Sign in to use AI'); return; }
        generateFeatureBtn.disabled = true;
        generateFeatureBtn.textContent = 'Generating...';
        try {
            const filesSnap = await userFilesRef.once('value');
            const filesData = filesSnap.val() || {};
            let prompt = "Suggest a realistic, actionable feature idea for this project based on these files:\n\n";
            for (const fname in filesData) {
                prompt += `--- ${fname} ---\n${(filesData[fname].content || '').slice(0, 800)}\n\n`;
            }
            prompt += "\nProvide 1 concise feature suggestion (1-2 sentences) and one example of how it would impact the UI or behavior.";
            const aiResp = await callServerQuery({ message: prompt, conversationType: 'code_plugin' });
            const replyText = aiResp.replyText || aiResp.result?.choices?.[0]?.message?.content || String(aiResp.result || '');
            featureInput.value = (replyText || '').replace(/^\s*["']?(.+)["']?\s*$/, '$1').slice(0, 800);
            showUserMessage('system', 'AI suggestion injected into the feature input.');
        } catch (e) {
            console.error(e);
            alert('Feature generation failed');
        } finally {
            generateFeatureBtn.disabled = false;
            generateFeatureBtn.textContent = 'Generate feature with AI';
        }
    });

    sendFeatureBtn.addEventListener('click', sendFeature);
    featureInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendFeature();
        }
    });

    async function sendFeature() {
        const featureText = featureInput.value.trim();
        if (!featureText) { alert('Write a feature description or generate one'); return; }
        await pushChatMessage({ role: 'user', content: featureText });
        showUserMessage('user', featureText);
        const prompt = `You are AiVA Code Assistant. The user described a feature:\n\n${featureText}\n\nPlease reply with a clear "What I understood" summary in 3-6 bullet points. Then ask the user: "Are you satisfied with this understanding? Reply Satisfied or Not satisfied."`;
        try {
            const aiResp = await callServerQuery({ message: prompt, conversationType: 'code_plugin' });
            const overview = aiResp.replyText || aiResp.result?.choices?.[0]?.message?.content || 'I have some ideas.';
            await pushChatMessage({ role: 'ai', content: overview });
            showUserMessage('ai', overview);
            renderSatisfactionButtons();
        } catch (e) {
            console.error('overview error', e);
            alert('AI overview failed');
        }
    }

    function showUserMessage(role, content) {
        const bubble = document.createElement('div');
        bubble.className = 'chat-bubble ' + (role === 'ai' ? 'ai' : 'user');
        bubble.innerHTML = `<div style="white-space:pre-wrap;">${escapeHtml(content)}</div>`;
        chatArea.appendChild(bubble);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function renderSatisfactionButtons() {
        const btnWrap = document.createElement('div');
        btnWrap.style.display = 'flex';
        btnWrap.style.gap = '8px';
        const sat = document.createElement('button');
        sat.className = 'btn btn-primary';
        sat.textContent = 'Satisfied';
        sat.addEventListener('click', () => onSatisfied());
        const notSat = document.createElement('button');
        notSat.className = 'btn btn-ghost';
        notSat.textContent = 'Not satisfied';
        notSat.addEventListener('click', () => onNotSatisfied());
        btnWrap.appendChild(sat);
        btnWrap.appendChild(notSat);
        chatArea.appendChild(btnWrap);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function onNotSatisfied() {
        showUserMessage('system', 'Please edit the feature description and press Send again.');
    }

    async function onSatisfied() {
        showUserMessage('system', 'AI will now generate code using current files as context. This may take a few seconds.');
        const filesSnap = await userFilesRef.once('value');
        const filesData = filesSnap.val() || {};
        let prompt = `You are an AI developer assistant. The user approved the feature: "${featureInput.value.trim()}". Based on current project files (below), generate the code necessary to implement this feature. For each file you produce, output in the following format exactly:\n\n===FILE: <filename>===\n\`\`\`<language>\n<file contents>\n\`\`\`\n\nOnly include files that need to be created or updated. Use concise but complete code. Current files:\n\n`;
        for (const fname in filesData) {
            prompt += `--- ${fname} ---\n${(filesData[fname].content || '').slice(0, 1200)}\n\n`;
        }
        try {
            const aiResp = await callServerQuery({ message: prompt, conversationType: 'code_plugin', max_tokens: 2000 });
            const respText = aiResp.replyText || aiResp.result?.choices?.[0]?.message?.content || String(aiResp.result || '');
            await pushChatMessage({ role: 'ai', content: respText });
            showUserMessage('ai', respText);
            lastAIHtml = renderAIGeneratedCode(respText);
        } catch (e) {
            console.error('generate code error', e);
            alert('AI code generation failed');
        }
    }

    let lastAIHtml = '';
    function renderAIGeneratedCode(text) {
        generatedArea.innerHTML = '';
        const parsed = parseAICodeBlocks(text);
        parsed.forEach(item => {
            const container = document.createElement('div');
            container.className = 'mb-3 p-3 bg-[#071025] rounded';
            const header = document.createElement('div');
            header.className = 'flex items-center justify-between mb-2';
            const name = document.createElement('div');
            name.className = 'text-sm text-gray-300';
            name.textContent = item.filename || 'generated';
            const actions = document.createElement('div');
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-ghost text-xs';
            copyBtn.textContent = 'Copy code';
            copyBtn.addEventListener('click', () => navigator.clipboard.writeText(item.code));
            const debugBtn = document.createElement('button');
            debugBtn.className = 'btn btn-ghost text-xs';
            debugBtn.textContent = 'Debug';
            debugBtn.addEventListener('click', () => debugCode(item.filename || 'generated', item.code));
            actions.appendChild(copyBtn);
            actions.appendChild(debugBtn);
            header.appendChild(name);
            header.appendChild(actions);
            container.appendChild(header);

            const pre = document.createElement('pre');
            const lang = detectLanguageFromFilename(item.filename);
            pre.className = 'language-' + lang;
            const code = document.createElement('code');
            code.className = 'language-' + lang;
            code.textContent = item.code;
            pre.appendChild(code);
            container.appendChild(pre);
            generatedArea.appendChild(container);
            Prism.highlightElement(code);
        });
        lastAIHtml = generatedArea.innerHTML;
        return lastAIHtml;
    }

    async function debugCode(filename, code) {
        const debugCard = document.createElement('div');
        debugCard.className = 'p-3 bg-[#071025] rounded mb-2';
        debugCard.innerHTML = `<div class="text-sm text-gray-300 mb-2">Debugging ${filename}...</div><div class="text-xs text-gray-400">AI is analyzing line-by-line</div>`;
        generatedArea.prepend(debugCard);
        try {
            const prompt = `You are an expert code reviewer. Debug the following file named ${filename}. Return a JSON object only (no surrounding text) with keys:\n{\n  "issues": [{ "line": <number>, "message": "<explain issue>" }],\n  "fixed_code": "<the full fixed file content as a single string>"\n}\n\nFile content:\n---START---\n${code}\n---END---\n\nIf there are no issues, return issues: [] and fixed_code should be the same as input.`;
            const aiResp = await callServerQuery({ message: prompt, conversationType: 'code_plugin', max_tokens: 1200 });
            let reply = aiResp.replyText || aiResp.result?.choices?.[0]?.message?.content || String(aiResp.result || '');
            const jsonText = extractJson(reply);
            if (!jsonText) {
                debugCard.innerHTML = `<div class="text-sm text-gray-300 mb-2">Debug result (raw):</div><pre class="text-xs text-gray-200" style="white-space:pre-wrap;">${escapeHtml(reply)}</pre>`;
                return;
            }
            const parsed = JSON.parse(jsonText);
            const lines = code.split('\n');
            const linesWrap = document.createElement('div');
            linesWrap.className = 'mt-3';
            const issuesMap = {};
            for (const iss of (parsed.issues || [])) issuesMap[iss.line] = iss.message;
            lines.forEach((ln, idx) => {
                const i = idx + 1;
                const span = document.createElement('div');
                span.className = 'debug-line ' + (issuesMap[i] ? 'line-issue' : 'line-ok');
                span.innerHTML = `<span style="color:#94a3b8;display:inline-block;width:40px;text-align:right;margin-right:8px;">${i}</span><span>${escapeHtml(ln)}</span>`;
                if (issuesMap[i]) {
                    const msg = document.createElement('div');
                    msg.className = 'text-xs text-red-300';
                    msg.textContent = issuesMap[i];
                    span.appendChild(msg);
                }
                linesWrap.appendChild(span);
            });
            debugCard.innerHTML = '';
            const title = document.createElement('div');
            title.className = 'text-sm text-gray-300 mb-2';
            title.textContent = `Debug overview for ${filename}`;
            debugCard.appendChild(title);
            debugCard.appendChild(linesWrap);

            const summary = document.createElement('div');
            summary.className = 'mt-3 text-xs text-gray-300';
            if ((parsed.issues || []).length === 0) summary.textContent = 'No issues found.';
            else summary.textContent = `Found ${parsed.issues.length} issue(s).`;
            debugCard.appendChild(summary);

            if ((parsed.issues || []).length > 0 && parsed.fixed_code) {
                const fixControls = document.createElement('div');
                fixControls.className = 'flex gap-2 mt-3';
                const acceptBtn = document.createElement('button');
                acceptBtn.className = 'btn btn-primary';
                acceptBtn.textContent = 'Accept fixes and replace file content';
                acceptBtn.addEventListener('click', async () => {
                    try {
                        await userFilesRef.child(filename).set({ content: parsed.fixed_code, lastModified: Date.now(), modifiedBy: currentUser.uid, version: (filesCache[filename]?.version || 0) + 1 });
                        showToast(`Updated ${filename} with fixes`);
                    } catch (e) {
                        console.error('apply fixes', e);
                        alert('Failed to apply fixes');
                    }
                });
                const showFixedBtn = document.createElement('button');
                showFixedBtn.className = 'btn btn-ghost';
                showFixedBtn.textContent = 'Show fixed code';
                showFixedBtn.addEventListener('click', () => {
                    const pre = document.createElement('pre');
                    const codeEl = document.createElement('code');
                    codeEl.className = 'language-' + detectLanguageFromFilename(filename);
                    codeEl.textContent = parsed.fixed_code;
                    pre.appendChild(codeEl);
                    debugCard.appendChild(pre);
                    Prism.highlightElement(codeEl);
                    showFixedBtn.disabled = true;
                });
                fixControls.appendChild(acceptBtn);
                fixControls.appendChild(showFixedBtn);
                debugCard.appendChild(fixControls);
            }
        } catch (e) {
            console.error('debug error', e);
            debugCard.innerHTML = `<div class="text-sm text-red-400">Debug failed. See console.</div>`;
        }
    }

    finalSatisfiedBtn.addEventListener('click', async () => {
        if (!confirm('If you press Satisfied, AI chat messages will be cleared and final code will be written to files. Proceed?')) return;
        if (chatMessages.length === 0) { alert('No AI content to commit'); return; }
        const lastAI = [...chatMessages].reverse().find(m => m.role === 'ai' && /```/.test(m.content));
        if (!lastAI) { alert('No AI generated code found'); return; }
        const parsed = parseAICodeBlocks(lastAI.content);
        for (const p of parsed) {
            const filename = p.filename || `generated_${Date.now()}.txt`;
            await userFilesRef.child(filename).set({ content: p.code, lastModified: Date.now(), modifiedBy: currentUser.uid, version: (filesCache[filename]?.version || 0) + 1 });
        }
        await userChatRef.child('messages').set([]);
        showToast('Final code committed and chat cleared.');
    });

    finalNotSatisfiedBtn.addEventListener('click', () => {
        showUserMessage('system', 'Please provide further instructions or modifications for the AI.');
    });

    deleteCodePlugin.addEventListener('click', () => {
        deleteCodeModal.classList.remove('hidden');
        confirmDeleteCheckbox.checked = false;
        confirmDeleteCode.disabled = true;
    });
    confirmDeleteCheckbox.addEventListener('change', () => {
        confirmDeleteCode.disabled = !confirmDeleteCheckbox.checked;
    });
    cancelDeleteCode.addEventListener('click', () => {
        deleteCodeModal.classList.add('hidden');
    });
    confirmDeleteCode.addEventListener('click', async () => {
        try {
            const base = uidPath();
            await database.ref(base).remove();
            deleteCodeModal.classList.add('hidden');
            closeCodePluginModal();
            enabledPlugins['code_editor'] = false;
            localStorage.setItem('aivaEnabledPlugins', JSON.stringify(enabledPlugins));
            codeBadge.textContent = 'Disabled';
            toggleCodePluginBtn.textContent = 'Enable Plugin';
            updateEnabledPluginsUI();
            alert('Plugin data deleted.');
        } catch (e) {
            console.error('delete plugin data', e);
            alert('Failed to delete plugin data.');
        }
    });

    /*************************************************************************
     * Main chat logic (simplified and integrated with server)
     *************************************************************************/
    function generateChatId() {
        return 'chat_' + Math.random().toString(36).slice(2, 10);
    }

    function updateMessageCount() {
        elements.messageCount.textContent = `${messageCount}/${MESSAGE_LIMIT}`;
        elements.mobileMessageCount.textContent = `${messageCount}/${MESSAGE_LIMIT}`;
        if (messageCount >= MESSAGE_LIMIT) {
            elements.warningBanner.classList.remove('hidden');
            elements.sendBtn.disabled = true;
            elements.messageInput.disabled = true;
        } else {
            elements.warningBanner.classList.add('hidden');
            elements.sendBtn.disabled = false;
            elements.messageInput.disabled = false;
        }
    }

    function showWarningBanner() {
        elements.warningBanner.classList.remove('hidden');
    }

    function hideWarningBanner() {
        elements.warningBanner.classList.add('hidden');
    }

    async function sendMessage() {
        const text = elements.messageInput.value.trim();
        if (!text) return;
        // increment local count and render
        messageCount++;
        updateMessageCount();

        appendMessageToUI('user', text);
        elements.messageInput.value = '';
        elements.messageInput.style.height = '';
        // send to server with conversation context (simplified)
        try {
            const payload = {
                message: text,
                conversationType: isChessConversation ? 'chess' : 'regular'
            };
            const resp = await fetch(`${SERVER_BASE}/api/query`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const json = await resp.json();
            const reply = json.replyText || 'Sorry, no reply.';
            appendMessageToUI('ai', reply);
        } catch (e) {
            console.error('sendMessage error', e);
            appendMessageToUI('ai', 'Failed to contact server. Try again later.');
        }
    }

    function appendMessageToUI(role, text) {
        const wrap = document.createElement('div');
        wrap.className = role === 'ai' ? 'flex items-start gap-3' : 'flex items-start gap-3 justify-end';
        const bubble = document.createElement('div');
        bubble.className = role === 'ai' ? 'code-block' : 'bg-blue-600 p-3 rounded-lg';
        bubble.style.maxWidth = '80%';
        bubble.innerHTML = `<div style="white-space:pre-wrap;">${escapeHtml(text)}</div>`;
        wrap.appendChild(bubble);
        elements.messagesContainer.appendChild(wrap);
        elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
    }

    /*************************************************************************
     * Auth, initialization and helpers
     *************************************************************************/
    function loadUserPreferences() {
        hasAcceptedTerms = localStorage.getItem('aivaTermsAccepted') === 'true';
        const savedArchived = localStorage.getItem('aivaArchivedChats');
        if (savedArchived) {
            try { archivedChats = JSON.parse(savedArchived); } catch (e) { archivedChats = {}; }
        }
        const savedPlugins = localStorage.getItem('aivaEnabledPlugins');
        if (savedPlugins) {
            try { enabledPlugins = JSON.parse(savedPlugins); } catch (e) { enabledPlugins = {}; }
        }
    }

    function saveUserPreferences() {
        localStorage.setItem('aivaTermsAccepted', 'true');
        localStorage.setItem('aivaArchivedChats', JSON.stringify(archivedChats));
        localStorage.setItem('aivaEnabledPlugins', JSON.stringify(enabledPlugins));
    }

    function showTermsModal() { elements.termsModal.classList.remove('hidden'); }

    document.getElementById('acceptTerms').addEventListener('click', () => {
        hasAcceptedTerms = true;
        saveUserPreferences();
        elements.termsModal.classList.add('hidden');
        checkAuthState();
    });
    document.getElementById('declineTerms').addEventListener('click', () => alert('You must accept terms to use AiVA'));

    function checkAuthState() {
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                showMainApp();
                loadUserData();
            } else {
                showAuthModal();
            }
        });
    }

    function showAuthModal() {
        elements.authModal.classList.remove('hidden');
        elements.mainApp.classList.add('hidden');
    }

    function showMainApp() {
        elements.authModal.classList.add('hidden');
        elements.mainApp.classList.remove('hidden');
        loadChatHistory();
        updateEnabledPluginsUI();
        startNewChat();
    }

    function setupEventListeners() {
        document.getElementById('showSignUp').addEventListener('click', () => {
            elements.loginForm.classList.add('hidden');
            elements.signUpForm.classList.remove('hidden');
        });
        document.getElementById('showSignIn').addEventListener('click', () => {
            elements.signUpForm.classList.add('hidden');
            elements.loginForm.classList.remove('hidden');
        });
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('signUpBtn').addEventListener('click', handleSignUp);
        document.getElementById('googleSignInBtn').addEventListener('click', handleGoogleSignIn);
        document.getElementById('googleSignUpBtn').addEventListener('click', handleGoogleSignIn);
        document.getElementById('signOutBtn').addEventListener('click', handleSignOut);

        document.getElementById('newChatBtn').addEventListener('click', startNewChat);
        document.getElementById('settingsBtn').addEventListener('click', showSettings);
        document.getElementById('closeSettings').addEventListener('click', hideSettings);
        document.getElementById('archiveBtn').addEventListener('click', showArchive);
        document.getElementById('closeArchive').addEventListener('click', hideArchive);
        document.getElementById('pluginsBtn').addEventListener('click', showPlugins);
        document.getElementById('closePlugins').addEventListener('click', hidePlugins);
        document.getElementById('clearHistory').addEventListener('click', clearChatHistory);

        document.getElementById('mobileMenuBtn')?.addEventListener('click', openMobileSidebar);
        document.getElementById('closeMobileMenu')?.addEventListener('click', closeMobileSidebar);
        elements.mobileOverlay.addEventListener('click', closeMobileSidebar);

        document.getElementById('chatMenuBtn').addEventListener('click', toggleChatDropdown);
        document.getElementById('archiveChat').addEventListener('click', archiveCurrentChat);
        document.getElementById('deleteChat').addEventListener('click', deleteCurrentChat);

        elements.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        elements.messageInput.addEventListener('input', autoResize);
        elements.sendBtn.addEventListener('click', sendMessage);
        document.getElementById('searchChats').addEventListener('input', filterChats);
        document.getElementById('mobileSearchChats')?.addEventListener('input', filterChats);

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#chatMenuBtn') && !e.target.closest('#chatDropdown')) elements.chatDropdown.classList.remove('active');
        });
    }

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try { await auth.signInWithEmailAndPassword(email, password); } catch (error) { alert('Login failed: ' + error.message); }
    }
    async function handleSignUp() {
        const email = document.getElementById('signUpEmail').value;
        const password = document.getElementById('signUpPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (password !== confirmPassword) { alert('Passwords do not match'); return; }
        try { await auth.createUserWithEmailAndPassword(email, password); } catch (error) { alert('Sign up failed: ' + error.message); }
    }
    async function handleGoogleSignIn() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try { await auth.signInWithPopup(provider); } catch (error) { alert('Google sign in failed: ' + error.message); }
    }
    async function handleSignOut() {
        try {
            await auth.signOut();
            currentUser = null;
            currentChatId = null;
            conversationHistory = [];
            chatHistoryData = {};
            messageCount = 0;
            closeMobileSidebar();
        } catch (error) { alert('Sign out failed: ' + error.message); }
    }

    function loadUserData() {
        if (currentUser) {
            const displayName = currentUser.displayName || currentUser.email;
            const photoURL = currentUser.photoURL;
            elements.userName.textContent = displayName;
            elements.userInitial.textContent = displayName.charAt(0).toUpperCase();
            elements.mobileUserName.textContent = displayName;
            elements.mobileUserInitial.textContent = displayName.charAt(0).toUpperCase();
            if (photoURL) {
                elements.userPhoto.src = photoURL;
                elements.userPhoto.classList.remove('hidden');
                elements.userInitial.style.display = 'none';
                elements.mobileUserPhoto.src = photoURL;
                elements.mobileUserPhoto.classList.remove('hidden');
                elements.mobileUserInitial.style.display = 'none';
            } else {
                elements.userPhoto.classList.add('hidden');
                elements.userInitial.style.display = 'flex';
                elements.mobileUserPhoto.classList.add('hidden');
                elements.mobileUserInitial.style.display = 'flex';
            }
        }
    }

    function startNewChat() {
        currentChatId = generateChatId();
        conversationHistory = [];
        messageCount = 0;
        isChessConversation = false;
        chessGameData = null;
        updateMessageCount();
        hideWarningBanner();
        elements.chatTitle.textContent = 'AiVA Assistant';
        elements.chatAvatar.innerHTML = 'AI';
        elements.chatAvatar.className = 'w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-sm font-bold';
        elements.messagesContainer.innerHTML = `
            <div class="text-center text-gray-500 mt-8">
                <div class="logo-placeholder mx-auto mb-4 pulse">AI</div>
                <h3 class="text-lg font-medium mb-1">New Conversation</h3>
                <p class="text-sm">How can I help you today?</p>
                <p class="text-xs text-gray-600 mt-2">You can send up to 7 messages per chat</p>
            </div>
        `;
        elements.messageInput.focus();
        elements.sendBtn.disabled = false;
        elements.messageInput.disabled = false;
    }

    function autoResize(e) {
        const el = e.target;
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 160) + 'px';
    }

    /*************************************************************************
     * Chat history (simple Firebase-backed storage)
     *************************************************************************/
    function loadChatHistory() {
        if (!currentUser) return;
        const ref = database.ref(`users/${currentUser.uid}/chats`);
        ref.on('value', snap => {
            const val = snap.val() || {};
            chatHistoryData = val;
            renderChatHistory();
        });
    }

    function renderChatHistory() {
        const container = document.getElementById('chatHistory');
        container.innerHTML = '';
        const items = Object.keys(chatHistoryData || {}).sort((a,b) => {
            const ta = chatHistoryData[a].lastModified || 0;
            const tb = chatHistoryData[b].lastModified || 0;
            return tb - ta;
        });
        if (items.length === 0) {
            container.innerHTML = `<div class="text-xs text-gray-400 p-2">No conversations yet.</div>`;
            return;
        }
        for (const id of items) {
            const meta = chatHistoryData[id];
            const div = document.createElement('div');
            div.className = 'file-card';
            div.innerHTML = `<div>
                <div class="text-sm font-medium">${meta.title || 'Conversation'}</div>
                <div class="text-xs text-gray-400">${new Date(meta.lastModified || Date.now()).toLocaleString()}</div>
            </div>
            <div style="display:flex;gap:6px;">
                <button class="btn btn-ghost text-xs">Open</button>
            </div>`;
            container.appendChild(div);
        }
    }

    function archiveCurrentChat() {
        alert('Archive chat - not implemented in demo.');
    }

    function deleteCurrentChat() {
        if (!confirm('Delete current chat?')) return;
        alert('Delete chat - not implemented in demo.');
    }

    function showPlugins() { elements.pluginsModal.classList.remove('hidden'); }
    function hidePlugins() { elements.pluginsModal.classList.add('hidden'); }
    function showSettings() { elements.settingsModal.classList.remove('hidden'); }
    function hideSettings() { elements.settingsModal.classList.add('hidden'); }
    function showArchive() { elements.archiveModal.classList.remove('hidden'); }
    function hideArchive() { elements.archiveModal.classList.add('hidden'); }
    function clearChatHistory() { if (confirm('Clear local chat history?')) { database.ref(`users/${currentUser.uid}/chats`).remove(); } }

    function openMobileSidebar() { elements.mobileSidebar.classList.add('open'); elements.mobileOverlay.classList.add('active'); }
    function closeMobileSidebar() { elements.mobileSidebar.classList.remove('open'); elements.mobileOverlay.classList.remove('active'); }

    function toggleChatDropdown() { elements.chatDropdown.classList.toggle('active'); }

    function filterChats(e) {
        const q = e.target.value.toLowerCase();
        const container = document.getElementById('chatHistory');
        Array.from(container.children).forEach(child => {
            const txt = child.textContent.toLowerCase();
            child.style.display = txt.includes(q) ? 'block' : 'none';
        });
    }

    /*************************************************************************
     * Init
     *************************************************************************/
    function initApp() {
        loadUserPreferences();
        setupEventListeners();
        if (hasAcceptedTerms) {
            elements.termsModal.classList.add('hidden');
            checkAuthState();
        } else showTermsModal();
        // restore plugin toggles
        const saved = localStorage.getItem('aivaEnabledPlugins');
        if (saved) {
            try { enabledPlugins = JSON.parse(saved); } catch (e) { enabledPlugins = {}; }
        }
        updateEnabledPluginsUI();
        // wire plugin open if previously enabled
        if (enabledPlugins['code_editor'] && auth.currentUser) {
            // can't open until auth triggers; handled in onAuthStateChanged
        }
    }

    auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            loadUserData();
            // ensure plugin list UI correct
            codeBadge.textContent = enabledPlugins['code_editor'] ? 'Enabled' : 'Disabled';
            toggleCodePluginBtn.textContent = enabledPlugins['code_editor'] ? 'Open Plugin' : 'Enable Plugin';
            updateEnabledPluginsUI();
        } else {
            closeCodePluginModal();
        }
    });

    // Run init once DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
        initApp();
    });

    </script>
</body>
</html>
