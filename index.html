<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dot & Box — Play vs AI</title>
  <style>
    /* Simple dark Claude-like UI — keep minimal */
    body{font-family:Arial,sans-serif;background:#0f1720;color:#e6eef6;margin:0;padding:28px;display:flex;justify-content:center}
    .card{width:820px;background:linear-gradient(180deg,#071024,#091227);padding:18px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    header h1{margin:0;font-size:18px}
    .main{display:flex;gap:18px}
    #game-board{display:grid;gap:6px;margin-top:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:#e6eef6}
    .line{background:#2b3440;cursor:pointer;border-radius:6px;transition:transform .06s}
    .line.horizontal{height:8px;width:64px}
    .line.vertical{width:8px;height:64px}
    .line.active{background:#444;cursor:default;opacity:0.9}
    .box{width:64px;height:64px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:transparent}
    .player-1{background:linear-gradient(180deg, rgba(47,110,255,0.14), rgba(47,110,255,0.08));color:#cfe0ff;font-weight:700}
    .player-2{background:linear-gradient(180deg, rgba(255,91,127,0.12), rgba(255,91,127,0.06));color:#ffe6ec;font-weight:700}
    #status{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);text-align:center;margin-bottom:6px;font-weight:700}
    #restart{margin-top:8px;padding:8px 10px;border-radius:8px;background:#111827;border:none;color:#e6eef6;cursor:pointer}
    /* Thinking overlay */
    #thinking-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:999}
    #thinking-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;display:flex;gap:12px;align-items:center;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    .dotpulse{width:9px;height:9px;border-radius:50%;background:#9aa4b2;animation:throb 1s infinite}
    .dotpulse:nth-child(2){animation-delay:.12s}.dotpulse:nth-child(3){animation-delay:.24s}
    @keyframes throb{0%{transform:translateY(0);opacity:.6}50%{transform:translateY(-6px);opacity:1}100%{transform:translateY(0);opacity:.6}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>Dot & Box — Play vs Smart AI</h1>
        <div style="color:#9aa4b2;font-size:13px">Board: 5 × 5 — AI decisions come from your configured web service</div>
      </div>
      <div>
        <button id="restart">Restart Game</button>
      </div>
    </header>

    <div id="status">Player 1's turn (You)</div>

    <div style="display:flex;gap:18px" class="main">
      <div>
        <div id="game-board"></div>
      </div>

      <aside style="width:260px">
        <div style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.01)">
          <div style="font-weight:700">AI endpoint</div>
          <div id="ai-endpoint" style="color:#9aa4b2;font-size:13px;margin-top:6px">loading config...</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <div style="flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);text-align:center">
            <div style="color:#9aa4b2">You</div>
            <div id="score-1" style="font-size:20px;font-weight:700">0</div>
          </div>
          <div style="flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.01);text-align:center">
            <div style="color:#9aa4b2">AI</div>
            <div id="score-2" style="font-size:20px;font-weight:700">0</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <button id="export" style="padding:8px;border-radius:8px;border:none;background:#111827;color:#e6eef6">Export State</button>
        </div>
      </aside>
    </div>
  </div>

  <!-- Thinking overlay -->
  <div id="thinking-overlay">
    <div id="thinking-card">
      <div style="display:flex;gap:8px">
        <div class="dotpulse"></div>
        <div class="dotpulse"></div>
        <div class="dotpulse"></div>
      </div>
      <div>
        <div style="font-weight:700">AI is thinking</div>
        <div style="color:#9aa4b2;font-size:13px">Calculating best move…</div>
      </div>
    </div>
  </div>

<script>
/* ====================== CONFIG: load config.json to get AI endpoint ====================== */
let AI_MOVE_URL = '/ai-move'; // default (if same host and api available)
fetch('config.json').then(r=>r.ok? r.json(): null).then(cfg=>{
  if(cfg && cfg.AI_MOVE_URL) AI_MOVE_URL = cfg.AI_MOVE_URL;
  document.getElementById('ai-endpoint').textContent = AI_MOVE_URL;
}).catch(e=>{
  document.getElementById('ai-endpoint').textContent = 'using default /ai-move (no config.json)';
});

/* ====================== Game (preserve original logic) ====================== */
const boardSize = 5;
const gameBoard = document.getElementById("game-board");
const status = document.getElementById("status");
const restartButton = document.getElementById("restart");
const score1El = document.getElementById("score-1");
const score2El = document.getElementById("score-2");
const thinkingOverlay = document.getElementById("thinking-overlay");
const exportBtn = document.getElementById("export");

let currentPlayer = 1; // 1 = human (blue), 2 = bot (red)
let scores = { 1: 0, 2: 0 };
let lines = new Set();
let gameOver = false;

function createBoard() {
  const gridTemplate = [];
  for (let i = 0; i < boardSize * 2 - 1; i++) gridTemplate.push("auto");
  gameBoard.style.gridTemplateColumns = gridTemplate.join(" ");
  gameBoard.innerHTML = "";

  for (let row = 0; row < boardSize * 2 - 1; row++) {
    for (let col = 0; col < boardSize * 2 - 1; col++) {
      if (row % 2 === 0 && col % 2 === 0) {
        const dot = document.createElement("div");
        dot.className = "dot";
        gameBoard.appendChild(dot);
      } else if (row % 2 === 0 || col % 2 === 0) {
        const line = document.createElement("div");
        line.className = `line ${row % 2 === 0 ? "horizontal" : "vertical"}`;
        line.dataset.row = row;
        line.dataset.col = col;
        line.addEventListener("click", () => selectLine(row, col));
        gameBoard.appendChild(line);
      } else {
        const box = document.createElement("div");
        box.className = "box";
        box.dataset.row = row;
        box.dataset.col = col;
        gameBoard.appendChild(box);
      }
    }
  }
}

function selectLine(row, col) {
  if (gameOver || currentPlayer !== 1) return;
  const key = `${row}-${col}`;
  if (lines.has(key)) return;

  lines.add(key);
  const el = document.querySelector(`.line[data-row="${row}"][data-col="${col}"]`);
  el.classList.add("active");
  el.style.backgroundColor = "#4a90e2";

  const gotBox = checkForCompletedBoxes(row, col);

  if (!gotBox) {
    currentPlayer = 2;
    updateStatus();
    setTimeout(makeBotMove, 600);
  } else {
    updateStatus();
  }

  if (isGameOver()) declareWinner();
}

function checkForCompletedBoxes(row, col) {
  let completed = false;
  const tryBox = (r, c) => {
    const top    = `${r-1}-${c}`, bottom = `${r+1}-${c}`,
          left   = `${r}-${c-1}`, right  = `${r}-${c+1}`;
    if ([top, bottom, left, right].every(l => lines.has(l))) {
      const box = document.querySelector(`.box[data-row="${r}"][data-col="${c}"]`);
      if (!box.classList.contains("player-1") && !box.classList.contains("player-2")) {
        box.classList.add(currentPlayer === 1 ? "player-1" : "player-2");
        box.textContent = currentPlayer;
        scores[currentPlayer]++;
        completed = true;
      }
    }
  };
  if (row % 2 === 0) {
    tryBox(row-1, col);
    tryBox(row+1, col);
  } else {
    tryBox(row, col-1);
    tryBox(row, col+1);
  }
  score1El.textContent = scores[1];
  score2El.textContent = scores[2];
  return completed;
}

function updateStatus() {
  if (gameOver) return;
  status.textContent = `Player ${currentPlayer}'s turn (${currentPlayer===1?"Blue":"Red (AI)"})`;
}

function isGameOver() {
  return scores[1] + scores[2] === (boardSize-1)*(boardSize-1);
}

function declareWinner() {
  gameOver = true;
  const winner = scores[1]>scores[2]?"Blue (You)":"Red (AI)";
  status.textContent = `${winner} is the winner!`;
}

function restartGame() {
  lines.clear();
  scores = {1:0,2:0};
  currentPlayer = 1;
  gameOver = false;
  createBoard();
  updateStatus();
  score1El.textContent = 0;
  score2El.textContent = 0;
}

restartButton.addEventListener("click", restartGame);
exportBtn.addEventListener("click", () => {
  const state = { boardSize, lines: Array.from(lines), scores, currentPlayer };
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'dotbox-state.json'; a.click();
  URL.revokeObjectURL(url);
});

createBoard();
updateStatus();

/* ========== Helpers for box-line counting (used by server heuristics/fallback) ========== */
function countBoxLines(r, c) {
  const top    = `${r-1}-${c}`, bottom = `${r+1}-${c}`,
        left   = `${r}-${c-1}`, right  = `${r}-${c+1}`;
  return [top, bottom, left, right].filter(l => lines.has(l)).length;
}
function boxClaimed(row,col){
  const box = document.querySelector(`.box[data-row="${row}"][data-col="${col}"]`);
  return box && (box.classList.contains("player-1") || box.classList.contains("player-2"));
}

/* ========== Applying Bot move (unchanged logic) ========== */
async function applyBotMove(choice) {
  if (!choice || typeof choice.row !== 'number' || typeof choice.col !== 'number') {
    console.warn('invalid bot move suggestion', choice);
    return fallbackApply();
  }
  const key = `${choice.row}-${choice.col}`;
  // if invalid or already taken -> fallback apply later
  if (lines.has(key) || choice.row < 0) {
    return fallbackApply();
  }
  lines.add(key);
  const el = document.querySelector(`.line[data-row="${choice.row}"][data-col="${choice.col}"]`);
  if (el) {
    el.classList.add("active");
    el.style.backgroundColor = "#e94e77";
  }
  const gotBox = checkForCompletedBoxes(choice.row, choice.col);
  if (!gotBox) {
    currentPlayer = 1;
    updateStatus();
  } else {
    updateStatus();
    setTimeout(makeBotMove, 700);
  }
  if (isGameOver()) declareWinner();
}

async function fallbackApply() {
  // pick first available
  const size = boardSize*2-1;
  for (let r=0;r<size;r++){
    for (let c=0;c<size;c++){
      const k = `${r}-${c}`;
      if ((r%2===0||c%2===0) && !(r%2===0 && c%2===0) && !lines.has(k)) {
        lines.add(k);
        const el = document.querySelector(`.line[data-row="${r}"][data-col="${c}"]`);
        if (el) { el.classList.add("active"); el.style.backgroundColor = "#e94e77"; }
        const gotBox = checkForCompletedBoxes(r,c);
        if (!gotBox) { currentPlayer = 1; updateStatus(); } else { updateStatus(); setTimeout(makeBotMove,700); }
        if (isGameOver()) declareWinner();
        return;
      }
    }
  }
}

/* ========== makeBotMove: calls configured AI endpoint ========== */
async function makeBotMove(){
  if (gameOver) return;
  currentPlayer = 2;
  updateStatus();
  thinkingOverlay.style.display = 'flex';

  const payload = { boardSize, lines: Array.from(lines), scores, currentPlayer };

  try {
    const resp = await fetch(AI_MOVE_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!resp.ok) throw new Error('AI service returned '+resp.status);
    const data = await resp.json();
    thinkingOverlay.style.display = 'none';
    // data expected: { row, col, explanation }
    await applyBotMove({row: data.row, col: data.col});
    // optionally show explanation in console
    if (data.explanation) console.info('AI:', data.explanation);
  } catch (err) {
    thinkingOverlay.style.display = 'none';
    console.error('AI call failed:', err);
    // fallback apply
    await fallbackApply();
  }
}

/* optional: disable right-click if you want to mimic original */
document.addEventListener('contextmenu', e => {});
</script>
</body>
</html>
